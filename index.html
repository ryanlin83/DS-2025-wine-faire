<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ· ç´…é…’å•†å“æŸ¥è©¢ç³»çµ± - é¼å±±åº—</title>

<!-- JsBarcode & html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  body{font-family:"Microsoft JhengHei",sans-serif;margin:0;padding:0;background:#faf5f2;text-align:center}
  header{margin:14px 0}
  header img{width:280px;max-width:90%;height:auto;display:block;margin:0 auto;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15)}
  h1{color:#6b0f1a;margin:8px 0;font-size:1.6rem}
  .container{max-width:980px;margin:12px auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.06)}
  textarea{width:90%;max-width:640px;height:70px;padding:10px;border-radius:8px;border:1px solid #ccc}
  .buttons{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:12px}
  button{background:#6b0f1a;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer}
  .note{color:#a00;margin-top:8px}
  #loading{display:none;position:fixed;inset:0;background:rgba(255,255,255,0.9);z-index:9999;align-items:center;justify-content:center;flex-direction:column}
  #loading video{width:180px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.2)}
  table{width:100%;border-collapse:collapse;margin-top:14px;font-size:0.95rem}
  th,td{border:1px solid #ddd;padding:8px;text-align:center;vertical-align:middle;word-break:break-word}
  th{background:#f2e5df;color:#6b0f1a}
  svg.barcode-svg{height:70px;width:auto;display:block;margin:0 auto}
  @media(max-width:600px){header img{width:180px}h1{font-size:1.2rem}textarea{height:60px}th,td{font-size:0.85rem;padding:6px}}
</style>
</head>
<body>

<header>
  <img src="wine-logo.jpg" alt="logo">
  <h1>ğŸ· ç´…é…’å•†å“æŸ¥è©¢ç³»çµ±ã€€åƒ…é™ã€Œé¼å±±åº—ã€ä½¿ç”¨</h1>
</header>

<div class="container">
  <h3>è«‹è¼¸å…¥è¨‚è³¼ç·¨è™Ÿï¼ˆä¾‹ï¼š01-01 æˆ–å¤šç­† 01-01, 03-01ï¼‰</h3>
  <textarea id="orderInput" placeholder="è¼¸å…¥è¨‚è³¼ç·¨è™Ÿ..."></textarea>

  <div class="buttons">
    <button id="searchBtn">æŸ¥è©¢</button>
    <button id="clearBtn">æ¸…ç©ºæŸ¥è©¢</button>
    <button id="downloadBtn">æŸ¥è©¢çµæœä¸‹è¼‰ï¼Œå¦å­˜æˆåœ–ç‰‡</button>
  </div>

  <div class="note">ç‚ºç¢ºä¿æŸ¥è©¢ç³»çµ±çš„æ“ä½œé«”é©—ï¼Œå–®æ¬¡æœ€å¤šæŸ¥è©¢æ”¯æ•¸è«‹ä»¥ 5 æ”¯ç‚ºé™ã€‚</div>

  <div id="result"></div>
</div>

<div id="loading">
  <video autoplay muted loop playsinline>
    <source src="wine-loading.mp4" type="video/mp4">
  </video>
  <div style="color:#6b0f1a;font-weight:700;margin-top:10px">è³‡æ–™æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™â€¦</div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzzcbfXKRWX-g4-YP8ATXFBPsGLn9-1Q-kwhxzNoQL6wzL-xhLk3SQ0KoiUdPPwQKtN_A/exec";

const searchBtn = document.getElementById('searchBtn');
const clearBtn = document.getElementById('clearBtn');
const downloadBtn = document.getElementById('downloadBtn');
const loading = document.getElementById('loading');
const resultDiv = document.getElementById('result');

// æŸ¥è©¢åŠŸèƒ½
searchBtn.addEventListener('click', async () => {
  const raw = document.getElementById('orderInput').value.trim();
  if (!raw) { alert('è«‹è¼¸å…¥è¨‚è³¼ç·¨è™Ÿ'); return; }
  const codes = raw.split(/[\n,ï¼Œ\s]+/).filter(Boolean);
  if (codes.length > 5) { alert('æ¯æ¬¡æœ€å¤šæŸ¥è©¢ 5 ç­†'); return; }

  loading.style.display = 'flex';
  resultDiv.innerHTML = '';

  try {
    const res = await fetch(`${SCRIPT_URL}?order=${encodeURIComponent(codes.join(','))}`);
    const data = await res.json();
    renderTable(data);
  } catch (err) {
    console.error('fetch error', err);
    alert('æŸ¥è©¢ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
  } finally {
    loading.style.display = 'none';
  }
});

// æ¸…ç©ºæŸ¥è©¢
clearBtn.addEventListener('click', () => {
  document.getElementById('orderInput').value = '';
  resultDiv.innerHTML = '';
});

// æ¸²æŸ“è¡¨æ ¼
function renderTable(data) {
  if (!data || data.length === 0) {
    resultDiv.innerHTML = '<p style="color:#c00">æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªè¨‚è³¼ç·¨è™Ÿã€‚</p>';
    return;
  }
  const headers = Object.keys(data[0]).filter(h => h !== 'æ¢ç¢¼åœ–');
  const insertIndex = headers.indexOf('å„ªæƒ æ´»å‹•');
  const displayHeaders = [...headers];
  displayHeaders.splice(insertIndex + 1, 0, 'æ•¸é‡');

  let html = '<table><tr>' + displayHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';
  data.forEach((row, idx) => {
    html += '<tr>';
    displayHeaders.forEach(h => {
      if (h === 'æ•¸é‡') {
        html += `<td><input type="number" min="0" placeholder="0" style="width:70px;"></td>`;
      } else if (h === 'æ¢ç¢¼') {
        const svgId = `barcode_${Date.now()}_${idx}`;
        html += `<td><svg id="${svgId}" class="barcode-svg"></svg></td>`;
      } else {
        html += `<td>${row[h] ?? ''}</td>`;
      }
    });
    html += '</tr>';
  });
  html += '</table>';
  resultDiv.innerHTML = html;

  const svgs = resultDiv.querySelectorAll('svg.barcode-svg');
  data.forEach((row, idx) => {
    const code = String(row['æ¢ç¢¼'] ?? '').trim();
    if (svgs[idx]) {
      try {
        JsBarcode(svgs[idx], code || '000000000000', {
          format: code.length === 13 ? 'ean13' : 'CODE128',
          displayValue: true,
          fontSize: 12,
          height: 60,
          width: 2,
          margin: 6
        });
      } catch (e) {
        console.warn('æ¢ç¢¼ç”Ÿæˆå¤±æ•—:', code, e);
      }
    }
  });
}

// æŸ¥è©¢çµæœä¸‹è¼‰
downloadBtn.addEventListener('click', async () => {
  if (!resultDiv.innerHTML.trim()) { alert('è«‹å…ˆæŸ¥è©¢å•†å“å¾Œå†ä¸‹è¼‰åœ–ç‰‡ï¼'); return; }

  const previewTab = window.open('about:blank', '_blank');
  if (!previewTab) {
    alert('ç€è¦½å™¨é˜»æ“‹äº†è·³å‡ºè¦–çª—ï¼Œè«‹å…è¨±æˆ–æ”¹ç”¨æ¡Œæ©Ÿã€‚');
    return;
  }

  previewTab.document.write(`<html><head><title>ç”Ÿæˆä¸­...</title></head><body style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial,sans-serif;"><div>åœ–ç‰‡ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™â€¦</div></body></html>`);

  try {
    await new Promise(r => setTimeout(r, 100));
    const opt = {
      scale: 2,
      useCORS: true,
      scrollX: 0,
      scrollY: -window.scrollY,
      windowWidth: resultDiv.scrollWidth,
      windowHeight: resultDiv.scrollHeight
    };

    const canvas = await html2canvas(resultDiv, opt);
    const dataUrl = canvas.toDataURL('image/png');

    previewTab.document.open();
    previewTab.document.write(`
      <html>
      <head>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>æŸ¥è©¢çµæœé è¦½</title>
        <style>
          body{margin:0;background:#faf6f3;display:flex;flex-direction:column;align-items:center;gap:12px;padding:16px;font-family:"Microsoft JhengHei",sans-serif}
          img{max-width:100%;height:auto;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
          .bar{display:flex;gap:8px;align-items:center}
          button{background:#6b0f1a;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
        </style>
      </head>
      <body>
        <div class="bar"><button id="closeBtn">â¬… é—œé–‰é è¦½</button><span style="color:#6b0f1a;font-weight:700">ğŸ“¸ æ‰“é–‹åœ–ç‰‡é è¦½ â†’ æ‰‹å‹•é•·æŒ‰å„²å­˜</span></div>
        <img id="resultImg" src="${dataUrl}" alt="æŸ¥è©¢çµæœ" />
        <script>document.getElementById('closeBtn').addEventListener('click',()=>window.close());</script>
      </body>
      </html>
    `);
    previewTab.document.close();

  } catch (err) {
    console.error('html2canvas éŒ¯èª¤:', err);
    previewTab.document.open();
    previewTab.document.write(`
      <html>
      <head>
        <meta charset="utf-8">
        <title>ç”Ÿæˆåœ–ç‰‡éŒ¯èª¤</title>
        <style>
          body {
            font-family: "Microsoft JhengHei", sans-serif;
            background: #fff3f3;
            color: #900;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            padding: 20px;
          }
          div {
            background: #fff;
            border: 2px solid #f5c2c2;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
          }
        </style>
      </head>
      <body>
        <div>
          <h2>âš ï¸ ç”Ÿæˆåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤</h2>
          <p>${String(err)}</p>
          <p>è«‹æ”¹ç”¨æ¡Œæ©Ÿæˆ–é‡æ–°æ•´ç†å¾Œå†è©¦ä¸€æ¬¡ã€‚</p>
        </div>
      </body>
      </html>
    `);
    previewTab.document.close();
  }
});
</script>

</body>
</html>
