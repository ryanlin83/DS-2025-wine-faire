<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç´…é…’å•†å“æŸ¥è©¢ç³»çµ±</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background: #faf7f5;
      color: #333;
      text-align: center;
      padding: 20px;
    }
    h1 {
      color: #800000;
    }
    textarea {
      width: 90%;
      height: 80px;
      margin: 10px 0;
      font-size: 16px;
      padding: 8px;
    }
    button {
      background: #800000;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background: #a00000;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 95%;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: #f0e0e0;
    }
    img {
      max-height: 80px;
    }
    .barcode-svg {
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ· ç´…é…’å•†å“æŸ¥è©¢ç³»çµ±</h1>
  <p>è«‹è¼¸å…¥ä¸€å€‹æˆ–å¤šå€‹è¨‚è³¼ç·¨è™Ÿï¼ˆå¯ç”¨é€—è™Ÿã€ç©ºç™½æˆ–æ›è¡Œåˆ†éš”ï¼‰ï¼š</p>
  <textarea id="orderInput" placeholder="ä¾‹å¦‚ï¼šA1001 æˆ–å¤šç­† A1001, A1002"></textarea><br>
  <button onclick="search()">æŸ¥è©¢</button>

  <table id="result">
    <tr><td>è«‹è¼¸å…¥è¨‚è³¼ç·¨è™Ÿå¾ŒæŒ‰ä¸‹æŸ¥è©¢</td></tr>
  </table>

  <!-- JsBarcode Library -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <script>
    // ä½ çš„ Google Apps Script ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbzzcbfXKRWX-g4-YP8ATXFBPsGLn9-1Q-kwhxzNoQL6wzL-xhLk3SQ0KoiUdPPwQKtN_A/exec";

    // æŸ¥è©¢æŒ‰éˆ•å‹•ä½œ
    async function search() {
      const input = document.getElementById('orderInput').value.trim();
      if (!input) {
        alert("è«‹è¼¸å…¥è¨‚è³¼ç·¨è™Ÿï¼");
        return;
      }

      document.getElementById('result').innerHTML = "<tr><td>æŸ¥è©¢ä¸­...</td></tr>";

      try {
        const res = await fetch(`${API_URL}?order=${encodeURIComponent(input)}`);
        const data = await res.json();
        renderTable(data);
      } catch (err) {
        console.error(err);
        document.getElementById('result').innerHTML = "<tr><td>æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</td></tr>";
      }
    }

    // ğŸ§® è¨ˆç®— EAN-13 æª¢æŸ¥ç¢¼
    function computeEAN13Checksum(code12) {
      if (!/^\d{12}$/.test(code12)) return null;
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        const digit = parseInt(code12.charAt(i), 10);
        sum += (i % 2 === 0) ? digit : digit * 3;
      }
      const mod = sum % 10;
      const check = (mod === 0) ? 0 : (10 - mod);
      return String(check);
    }

    // ç¢ºä¿æ¢ç¢¼ç‚ºæ­£ç¢ºçš„ EAN-13
    function ensureEAN13(code) {
      const raw = String(code || '').replace(/\s+/g, '');
      if (/^\d{13}$/.test(raw)) {
        const body = raw.slice(0, 12);
        const expected = computeEAN13Checksum(body);
        if (expected === raw.charAt(12)) return raw;
        return body + expected;
      }
      if (/^\d{12}$/.test(raw)) {
        const check = computeEAN13Checksum(raw);
        return raw + check;
      }
      return null;
    }

    // å°‡ EAN-13 æ¢ç¢¼ç¹ªè£½åˆ°å„²å­˜æ ¼ä¸­
    function renderEAN13IntoCell(td, code) {
      td.innerHTML = '';
      const ean = ensureEAN13(String(code || ''));
      if (!ean) {
        td.textContent = code ?? '';
        return;
      }
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.classList.add('barcode-svg');
      td.appendChild(svg);
      try {
        JsBarcode(svg, ean, {
          format: "ean13",
          displayValue: true,
          fontSize: 12,
          width: 2,
          height: 50,
          margin: 4
        });
      } catch (err) {
        td.textContent = code;
      }
    }

    // é¡¯ç¤ºæŸ¥è©¢çµæœè¡¨æ ¼
    function renderTable(data) {
      const table = document.getElementById('result');
      if (!data || data.length === 0) {
        table.innerHTML = "<tr><td>æŸ¥ç„¡è³‡æ–™</td></tr>";
        return;
      }

      const headers = Object.keys(data[0]);
      let html = "<tr>" + headers.map(h => `<th>${h}</th>`).join('') + "</tr>";
      html += data.map(row => {
        return "<tr>" + headers.map(h => `<td data-col="${h}">${row[h] ?? ''}</td>`).join('') + "</tr>";
      }).join('');
      table.innerHTML = html;

      // é‡å°æ¯å€‹å„²å­˜æ ¼ï¼Œè™•ç†æ¢ç¢¼æˆ–åœ–ç‰‡æ¬„ä½
      table.querySelectorAll('td[data-col]').forEach(td => {
        const col = td.getAttribute('data-col');
        const value = td.textContent || '';
        td.textContent = ''; // æ¸…ç©ºä»¥åˆ©æ’å…¥å…§å®¹

        if (/æ¢ç¢¼åœ–|image/i.test(col)) {
          if (value.startsWith('http') || value.startsWith('data:')) {
            const img = document.createElement('img');
            img.src = value;
            img.alt = 'æ¢ç¢¼åœ–';
            td.appendChild(img);
          } else {
            td.textContent = value;
          }
          return;
        }

        if (/æ¢ç¢¼|barcode|EAN/i.test(col)) {
          renderEAN13IntoCell(td, value);
          return;
        }

        td.textContent = value;
      });
    }
  </script>
</body>
</html>
