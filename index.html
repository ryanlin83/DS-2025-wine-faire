<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>🍷 紅酒商品查詢系統 - 鼎山店</title>

<!-- JsBarcode & html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  body{font-family:"Microsoft JhengHei",sans-serif;margin:0;padding:0;background:#faf5f2;text-align:center}
  header{margin:14px 0}
  header img{width:280px;max-width:90%;height:auto;display:block;margin:0 auto;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15)}
  h1{color:#6b0f1a;margin:8px 0;font-size:1.6rem}
  .container{max-width:980px;margin:12px auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.06)}
  textarea{width:90%;max-width:640px;height:70px;padding:10px;border-radius:8px;border:1px solid #ccc}
  .buttons{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:12px}
  button{background:#6b0f1a;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer}
  .note{color:#a00;margin-top:8px}
  #loading{display:none;position:fixed;inset:0;background:rgba(255,255,255,0.9);z-index:9999;align-items:center;justify-content:center;flex-direction:column}
  #loading video{width:180px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.2)}
  table{width:100%;border-collapse:collapse;margin-top:14px;font-size:0.95rem}
  th,td{border:1px solid #ddd;padding:8px;text-align:center;vertical-align:middle;word-break:break-word}
  th{background:#f2e5df;color:#6b0f1a}
  svg.barcode-svg{height:70px;width:auto;display:block;margin:0 auto}
  @media(max-width:600px){header img{width:180px}h1{font-size:1.2rem}textarea{height:60px}th,td{font-size:0.85rem;padding:6px}}
</style>
</head>
<body>

<header>
  <img src="wine-logo.jpg" alt="logo">
  <h1>🍷 紅酒商品查詢系統　僅限「鼎山店」使用</h1>
</header>

<div class="container">
  <h3>請輸入訂購編號（例：01-01 或多筆 01-01, 03-01）</h3>
  <textarea id="orderInput" placeholder="輸入訂購編號..."></textarea>

  <div class="buttons">
    <button id="searchBtn">查詢</button>
    <button id="clearBtn">清空查詢</button>
    <button id="downloadBtn">查詢結果下載，另存成圖片</button>
  </div>

  <div class="note">為確保查詢系統的操作體驗，單次最多查詢支數請以 5 支為限。</div>

  <div id="result"></div>
</div>

<div id="loading">
  <video autoplay muted loop playsinline>
    <source src="wine-loading.mp4" type="video/mp4">
  </video>
  <div style="color:#6b0f1a;font-weight:700;margin-top:10px">資料查詢中，請稍候…</div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzzcbfXKRWX-g4-YP8ATXFBPsGLn9-1Q-kwhxzNoQL6wzL-xhLk3SQ0KoiUdPPwQKtN_A/exec";

const searchBtn = document.getElementById('searchBtn');
const clearBtn = document.getElementById('clearBtn');
const downloadBtn = document.getElementById('downloadBtn');
const loading = document.getElementById('loading');
const resultDiv = document.getElementById('result');

// 查詢功能
searchBtn.addEventListener('click', async () => {
  const raw = document.getElementById('orderInput').value.trim();
  if (!raw) { alert('請輸入訂購編號'); return; }
  const codes = raw.split(/[\n,，\s]+/).filter(Boolean);
  if (codes.length > 5) { alert('每次最多查詢 5 筆'); return; }

  loading.style.display = 'flex';
  resultDiv.innerHTML = '';

  try {
    const res = await fetch(`${SCRIPT_URL}?order=${encodeURIComponent(codes.join(','))}`);
    const data = await res.json();
    renderTable(data);
  } catch (err) {
    console.error('fetch error', err);
    alert('查詢發生錯誤，請稍後再試。');
  } finally {
    loading.style.display = 'none';
  }
});

// 清空查詢
clearBtn.addEventListener('click', () => {
  document.getElementById('orderInput').value = '';
  resultDiv.innerHTML = '';
});

// 渲染表格
function renderTable(data) {
  if (!data || data.length === 0) {
    resultDiv.innerHTML = '<p style="color:#c00">查無資料，請確認訂購編號。</p>';
    return;
  }
  const headers = Object.keys(data[0]).filter(h => h !== '條碼圖');
  const insertIndex = headers.indexOf('優惠活動');
  const displayHeaders = [...headers];
  displayHeaders.splice(insertIndex + 1, 0, '數量');

  let html = '<table><tr>' + displayHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';
  data.forEach((row, idx) => {
    html += '<tr>';
    displayHeaders.forEach(h => {
      if (h === '數量') {
        html += `<td><input type="number" min="0" placeholder="0" style="width:70px;"></td>`;
      } else if (h === '條碼') {
        const svgId = `barcode_${Date.now()}_${idx}`;
        html += `<td><svg id="${svgId}" class="barcode-svg"></svg></td>`;
      } else {
        html += `<td>${row[h] ?? ''}</td>`;
      }
    });
    html += '</tr>';
  });
  html += '</table>';
  resultDiv.innerHTML = html;

  const svgs = resultDiv.querySelectorAll('svg.barcode-svg');
  data.forEach((row, idx) => {
    const code = String(row['條碼'] ?? '').trim();
    if (svgs[idx]) {
      try {
        JsBarcode(svgs[idx], code || '000000000000', {
          format: code.length === 13 ? 'ean13' : 'CODE128',
          displayValue: true,
          fontSize: 12,
          height: 60,
          width: 2,
          margin: 6
        });
      } catch (e) {
        console.warn('條碼生成失敗:', code, e);
      }
    }
  });
}

// 查詢結果下載
downloadBtn.addEventListener('click', async () => {
  if (!resultDiv.innerHTML.trim()) { alert('請先查詢商品後再下載圖片！'); return; }

  const previewTab = window.open('about:blank', '_blank');
  if (!previewTab) {
    alert('瀏覽器阻擋了跳出視窗，請允許或改用桌機。');
    return;
  }

  previewTab.document.write(`<html><head><title>生成中...</title></head><body style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial,sans-serif;"><div>圖片生成中，請稍候…</div></body></html>`);

  try {
    await new Promise(r => setTimeout(r, 100));
    const opt = {
      scale: 2,
      useCORS: true,
      scrollX: 0,
      scrollY: -window.scrollY,
      windowWidth: resultDiv.scrollWidth,
      windowHeight: resultDiv.scrollHeight
    };

    const canvas = await html2canvas(resultDiv, opt);
    const dataUrl = canvas.toDataURL('image/png');

    previewTab.document.open();
    previewTab.document.write(`
      <html>
      <head>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>查詢結果預覽</title>
        <style>
          body{margin:0;background:#faf6f3;display:flex;flex-direction:column;align-items:center;gap:12px;padding:16px;font-family:"Microsoft JhengHei",sans-serif}
          img{max-width:100%;height:auto;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
          .bar{display:flex;gap:8px;align-items:center}
          button{background:#6b0f1a;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
        </style>
      </head>
      <body>
        <div class="bar"><button id="closeBtn">⬅ 關閉預覽</button><span style="color:#6b0f1a;font-weight:700">📸 打開圖片預覽 → 手動長按儲存</span></div>
        <img id="resultImg" src="${dataUrl}" alt="查詢結果" />
        <script>document.getElementById('closeBtn').addEventListener('click',()=>window.close());</script>
      </body>
      </html>
    `);
    previewTab.document.close();

  } catch (err) {
    console.error('html2canvas 錯誤:', err);
    previewTab.document.open();
    previewTab.document.write(`
      <html>
      <head>
        <meta charset="utf-8">
        <title>生成圖片錯誤</title>
        <style>
          body {
            font-family: "Microsoft JhengHei", sans-serif;
            background: #fff3f3;
            color: #900;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            padding: 20px;
          }
          div {
            background: #fff;
            border: 2px solid #f5c2c2;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
          }
        </style>
      </head>
      <body>
        <div>
          <h2>⚠️ 生成圖片時發生錯誤</h2>
          <p>${String(err)}</p>
          <p>請改用桌機或重新整理後再試一次。</p>
        </div>
      </body>
      </html>
    `);
    previewTab.document.close();
  }
});
</script>

</body>
</html>
