<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç´…é…’å•†å“æŸ¥è©¢ç³»çµ±</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background: #faf7f5;
      color: #333;
      text-align: center;
      padding: 15px;
    }

    h1 {
      color: #800000;
      font-size: 1.6em;
      margin-bottom: 10px;
    }

    textarea {
      width: 95%;
      height: 80px;
      margin: 10px 0;
      font-size: 16px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: vertical;
    }

    button {
      background: #800000;
      color: white;
      border: none;
      padding: 10px 18px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin: 6px;
    }

    button:hover {
      background: #a00000;
    }

    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      width: 100%;
      margin-top: 15px;
    }

    table {
      border-collapse: collapse;
      min-width: 800px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin: 0 auto;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 14px;
      word-break: break-word;
      vertical-align: middle;
    }

    th {
      background: #f0e0e0;
    }

    img {
      max-height: 60px;
    }

    .barcode-svg {
      display: block;
      margin: 0 auto;
      width: 140px;
      height: 60px;
      max-width: 100%;
    }

    /* æ‰‹æ©Ÿç‰ˆèª¿æ•´ */
    @media (max-width: 600px) {
      h1 { font-size: 1.3em; }
      textarea { font-size: 14px; }
      button { font-size: 14px; padding: 8px 12px; }
      th, td { font-size: 12px; padding: 5px; }
      img { max-height: 50px; }
    }

    /* âœ… æŸ¥è©¢ä¸­é®ç½© */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      color: #800000;
      z-index: 9999;
      backdrop-filter: blur(4px);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #loadingOverlay.show {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
  <h1>ğŸ· ç´…é…’å•†å“æŸ¥è©¢ç³»çµ±</h1>
  <p>è«‹è¼¸å…¥ä¸€å€‹æˆ–å¤šå€‹è¨‚è³¼ç·¨è™Ÿï¼ˆå¯ç”¨é€—è™Ÿã€ç©ºç™½æˆ–æ›è¡Œåˆ†éš”ï¼‰ï¼š</p>
  <textarea id="orderInput" placeholder="ä¾‹å¦‚ï¼š01-01 æˆ–å¤šç­† 01-01, 05-01"></textarea><br>
  <button onclick="search()">æŸ¥è©¢</button>
  <button onclick="downloadImage()">ä¸‹è¼‰çµæœåœ–ç‰‡</button>

  <div id="resultWrapper" class="table-container">
    <table id="result">
      <tr><td>è«‹è¼¸å…¥è¨‚è³¼ç·¨è™Ÿå¾ŒæŒ‰ä¸‹æŸ¥è©¢</td></tr>
    </table>
  </div>

  <!-- âœ… æŸ¥è©¢ä¸­æµ®å±¤ -->
  <div id="loadingOverlay">ğŸ” è³‡æ–™æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å¾Œ...</div>

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvg@4.0.1/lib/umd.min.js"></script>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzzcbfXKRWX-g4-YP8ATXFBPsGLn9-1Q-kwhxzNoQL6wzL-xhLk3SQ0KoiUdPPwQKtN_A/exec";

    function showLoading(show) {
      const overlay = document.getElementById("loadingOverlay");
      if (show) overlay.classList.add("show");
      else overlay.classList.remove("show");
    }

    async function search() {
      const input = document.getElementById('orderInput').value.trim();
      if (!input) {
        alert("è«‹è¼¸å…¥è¨‚è³¼ç·¨è™Ÿï¼");
        return;
      }

      document.getElementById('result').innerHTML = "<tr><td>æŸ¥è©¢ä¸­...</td></tr>";
      showLoading(true);

      try {
        const res = await fetch(`${API_URL}?order=${encodeURIComponent(input)}`);
        const data = await res.json();
        renderTable(data);
      } catch (err) {
        console.error(err);
        document.getElementById('result').innerHTML = "<tr><td>æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</td></tr>";
      } finally {
        showLoading(false);
      }
    }

    function computeEAN13Checksum(code12) {
      if (!/^\d{12}$/.test(code12)) return null;
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        const digit = parseInt(code12.charAt(i), 10);
        sum += (i % 2 === 0) ? digit : digit * 3;
      }
      const mod = sum % 10;
      return mod === 0 ? "0" : String(10 - mod);
    }

    function ensureEAN13(code) {
      let raw = String(code || '').replace(/\s+/g, '');
      if (!/^\d+$/.test(raw)) return null;
      if (raw.length < 12) raw = raw.padStart(12, '0');
      if (raw.length > 13) raw = raw.slice(0, 13);
      if (raw.length === 12) return raw + computeEAN13Checksum(raw);
      if (raw.length === 13) {
        const body = raw.slice(0, 12);
        return body + computeEAN13Checksum(body);
      }
      return null;
    }

    function createBarcodeFromNumber(code) {
      const ean = ensureEAN13(code);
      if (!ean) return null;
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.classList.add('barcode-svg');
      try {
        JsBarcode(svg, ean, {
          format: "ean13",
          displayValue: true,
          fontSize: 12,
          width: 2,
          height: 50,
          margin: 4
        });
        return svg;
      } catch {
        return null;
      }
    }

    function renderTable(data) {
      const table = document.getElementById('result');
      if (!data || data.length === 0) {
        table.innerHTML = "<tr><td>æŸ¥ç„¡è³‡æ–™</td></tr>";
        return;
      }

      const headers = Object.keys(data[0]);
      let html = "<tr>" + headers.map(h => `<th>${h}</th>`).join('') + "</tr>";
      html += data.map(row => {
        return "<tr>" + headers.map(h => `<td data-col='${h}'>${row[h] ?? ''}</td>`).join('') + "</tr>";
      }).join('');
      table.innerHTML = html;

      table.querySelectorAll('tr').forEach(tr => {
        const tds = tr.querySelectorAll('td[data-col]');
        let barcodeValue = null;
        let barcodeImgCell = null;

        tds.forEach(td => {
          const col = td.getAttribute('data-col');
          const value = td.textContent.trim();
          if (col === "æ¢ç¢¼") barcodeValue = value;
          if (col === "æ¢ç¢¼åœ–") barcodeImgCell = td;
        });

        if (barcodeImgCell) {
          const original = barcodeImgCell.textContent.trim();
          barcodeImgCell.textContent = '';
          if (original.startsWith('http')) {
            const img = document.createElement('img');
            img.src = original;
            img.alt = 'æ¢ç¢¼åœ–';
            barcodeImgCell.appendChild(img);
          } else if (barcodeValue) {
            const svg = createBarcodeFromNumber(barcodeValue);
            if (svg) barcodeImgCell.appendChild(svg);
            else barcodeImgCell.textContent = '(æ¢ç¢¼ç„¡æ•ˆ)';
          }
        }
      });
    }

    async function convertSVGtoImage() {
      const svgs = document.querySelectorAll("svg.barcode-svg");
      for (const svg of svgs) {
        const svgString = new XMLSerializer().serializeToString(svg);
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const v = await Canvg.fromString(ctx, svgString);
        canvas.width = svg.width.baseVal.value || 140;
        canvas.height = svg.height.baseVal.value || 60;
        await v.render();
        const img = document.createElement("img");
        img.src = canvas.toDataURL("image/png");
        img.style.maxHeight = "60px";
        svg.replaceWith(img);
      }
    }

    async function downloadImage() {
      const wrapper = document.getElementById("resultWrapper");
      if (!wrapper || wrapper.innerText.includes("æŸ¥è©¢ä¸­") || wrapper.innerText.includes("è«‹è¼¸å…¥")) {
        alert("è«‹å…ˆæŸ¥è©¢å•†å“å†ä¸‹è¼‰åœ–ç‰‡ï¼");
        return;
      }

      showLoading(true);
      await convertSVGtoImage(); // âœ… è½‰æ›æ‰€æœ‰æ¢ç¢¼æˆåœ–ç‰‡

      await new Promise(r => setTimeout(r, 500));

      const canvas = await html2canvas(wrapper, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff"
      });

      showLoading(false);

      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#800000";
      ctx.font = "bold 28px Microsoft JhengHei";
      ctx.fillText("ğŸ· ç´…é…’å•†å“æŸ¥è©¢çµæœ", 40, 40);
      ctx.font = "20px Microsoft JhengHei";
      ctx.fillStyle = "#555";
      ctx.fillText(new Date().toLocaleString(), 40, 70);

      const imgData = canvas.toDataURL("image/png");
      const confirmDownload = confirm("æ˜¯å¦ä¸‹è¼‰æŸ¥è©¢çµæœåœ–ç‰‡ï¼Ÿ");
      if (confirmDownload) {
        const link = document.createElement("a");
        link.href = imgData;
        link.download = "ç´…é…’æŸ¥è©¢çµæœ.png";
        link.click();
      }
    }
  </script>
</body>
</html>

